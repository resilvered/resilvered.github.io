<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      How to Shrink zfs root pool. &middot; Al's Ramblings
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="/public/css/custom.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">

  <!-- JS -->
  <script type="text/javascript" src="/assets/js/jquery-1.11.1.min.js"></script>

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-52963682-1', 'auto');
  ga('send', 'pageview');

</script>

  <body class="theme-base-0b">

    <div class="sidebar">
  
    <div class="sidebar-about">
      <h1>
        <a href="">
          Al's Ramblings
        </a>
      </h1>
      <p class="lead">Automation, UNIX and other assorted random thoughts</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="">home</a>

      

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/archive/">archives</a>
          
        
      
        
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/presentations/">presentations</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/tags/">tags</a>
          
        
      
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      

      </nav>
      <div id="social-bar">
        <a href="http://www.linkedin.com/in/alanchalmers/" title="Alan Chalmers on LinkedIn" rel="me"><i class="fa fa-linkedin-square fa-2x"></i></a>
        <a href="https://github.com/bigal/" title="Alan Chalmers on GitHub" rel="me"><i class="fa fa-github-square fa-2x"></i></a> 
        <a href="https://twitter.com/bigal" title="Alan Chalmers on Twitter" rel="me"><i class="fa fa-twitter-square fa-2x"></i></a>
       <a href="https://plus.google.com/+AlanChalmers/" title="Alan Chalmers on Google+" rel="me"><i class="fa fa-google-plus-square fa-2x"></i></a> 
      <p>&copy; 2022. All rights reserved.</p>
    </div>
</div>


    <div class="content container">
      <div class="post">
  <h1 class="post-title">How to Shrink zfs root pool.</h1>
  <span class="post-date">30 Jul 2011</span>
  <div class="css-full-post-content js-full-post-content">
This exercise for me is to replace my current single disk rpool, the second disk was removed for another project, on to two slightly smaller disks. Doing so restores my root mirror but as the disks are slightly smaller some work is required.<br /><br />For reference my current root pool name is rpool, the current disk in this pool is c5t1d0, the first replacement disk is install at c5t0d0 and is empty.<br /><br />Use fdisk create a Solaris patition.<br /><pre># fdisk /dev/rdsk/c5t0d0p0<br />No fdisk table exists. The default partition for the disk is:<br /><br />a 100% "SOLARIS System" partition<br /><br />Type "y" to accept the default partition,  otherwise type "n" to edit the<br />partition table.<br />n<br /><br />        Total disk size is 7788 cylinders<br />        Cylinder size is 12544 (512 byte) blocks<br /><br />                                          Cylinders<br /> Partition   Status    Type          Start   End   Length    %<br /> =========   ======    ============  =====   ===   ======   ===<br />     1       Active    Solaris2          1  4672    4672     60<br />     2                 Win95 FAT32    4673  7787    3115     40<br /><br /><br /><br />SELECT ONE OF THE FOLLOWING:<br />1. Create a partition<br />2. Specify the active partition<br />3. Delete a partition<br />4. Change between Solaris and Solaris2 Partition IDs<br />5. Edit/View extended partitions<br />6. Exit (update disk configuration and exit)<br />7. Cancel (exit without updating disk configuration)<br />Enter Selection: 6<br /></pre><br />Use format and create Silce 0 using the whole partition<br /><br />Create temporary new pool on new disk<br /><pre># zpool create -f tpool c5t0d0s0<br /># zfs set compression=on tpool<br /></pre><br /><br />Snaphot and copy to my new tpool<br /><br /><pre># zfs snapshot -r rpool@shrink<br /># zfs send -vR rpool@shrink | zfs receive -vFd tpool<br /></pre><br /><br />Prepare for booting<br /><pre># rm /tpool/boot/grub/bootsign/pool_rpool<br /># touch /tpool/boot/grub/bootsign/pool_tpool<br /># zpool set bootfs=tpool/ROOT/Solaris_11_SRU4 tpool<br /># cd /boot/grub/<br /># /sbin/installgrub stage1 stage2 /dev/rdsk/c5t0d0s0<br />stage2 written to partition 0, 277 sectors starting at 50 (abs 12594)<br />stage1 written to partition 0 sector 0 (abs 12544)<br /># vi /tpool/boot/grub/menu.lst<br /></pre><br />Change all the references to tpool to rpool in the menu.1st file.<br /><br />At this point shutdown, on power up go into the BIOS and make sure you are booting off the right disk. If you need to be sure remove the current boot disk<br /><br />Once confrimed I'm running off my new root pool, tpool, I shutdown install the second new drive as c5t1d0 and restart<br /><br />At this stage I could just attach my new disk to the mirror and we are in buisness, but I'd like to keep my root pool name as rpool. So I perform pretty much the same proceedure as before.<br /><br />Use fdisk to partition the disk<br /><pre># fdisk /dev/rdsk/c5t0d0p0<br /></pre><br /><br />Copy over the vtoc to my new disk<br /><pre># prtvtoc  /dev/rdsk/c5t0d0s2 | fmthard -s - /dev/rdsk/c5t1d0s2<br /><br /># zpool create -f rpool c5t1d0s0<br /># zfs set compression=on rpool<br /></pre><br />Clean up my shrink snapshots from the first run<br /><pre># zfs list -t snapshot | grep shrink<br />tpool@shrink                                      23K      -    80K  -<br />tpool/ROOT@shrink                                   0      -    21K  -<br />tpool/ROOT/Solaris_11_SRU3@shrink                   0      -  3.11G  -<br />tpool/ROOT/Solaris_11_SRU4@shrink               96.2M      -  3.15G  -<br />tpool/ROOT/opensolaris@shrink                       0      -  2.04G  -<br />tpool/ROOT/opensolaris-134b@shrink                  0      -  2.75G  -<br />tpool/ROOT/opensolaris-134b-1@shrink                0      -  2.92G  -<br />tpool/dump@shrink                                   0      -  1019M  -<br />tpool/swap@shrink                                   0      -   353M  -<br /><br /># zfs destroy tpool@shrink<br /># zfs destroy tpool/ROOT@shrink<br /># zfs destroy tpool/ROOT/Solaris_11_SRU3@shrink<br /># zfs destroy tpool/ROOT/Solaris_11_SRU4@shrink<br /># zfs destroy tpool/ROOT/opensolaris-134b@shrink<br /># zfs destroy tpool/ROOT/opensolaris-134b-1@shrink<br /># zfs destroy tpool/dump@shrink<br /># zfs destroy tpool/swap@shrink<br /># zfs destroy tpool/ROOT/opensolaris@shrink<br /><br /># zfs snapshot -r tpool@shrink<br /># zfs send -vR tpool@shrink | zfs receive -vFd rpool<br /><br /># rm /rpool/boot/grub/bootsign/pool_tpool<br /># touch /rpool/boot/grub/bootsign/pool_rpool<br /># zpool set bootfs=rpool/ROOT/Solaris_11_SRU4 rpool<br /># cd /boot/grub/<br /># /sbin/installgrub stage1 stage2 /dev/rdsk/c5t1d0s0<br />stage2 written to partition 0, 277 sectors starting at 50 (abs 12594)<br />stage1 written to partition 0 sector 0 (abs 12544)<br /># vi /rpool/boot/grub/menu.lst<br /># reboot -p<br /></pre><br /><br />Change all references of tpool to rpool in menu.lst<br /><br />Reboot go back to BIOS and make sure I'm now booting of my new root pool called rpool<br /><br /><pre># zpool list<br />NAME    SIZE  ALLOC   FREE    CAP  DEDUP  HEALTH  ALTROOT<br />rpool  27.8G  6.96G  20.8G    25%  1.00x  ONLINE  -<br />tpool  27.8G  6.90G  20.8G    24%  1.00x  ONLINE  -<br /># zpool destroy tpool<br /># zpool attach -f rpool c5t1d0s0 c5t0d0s0<br />Make sure to wait until resilver is done before rebooting.<br /># zpool status rpool<br />pool: rpool<br />state: ONLINE<br />status: One or more devices is currently being resilvered.  The pool will<br />   continue to function, possibly in a degraded state.<br />action: Wait for the resilver to complete.<br />scan: resilver in progress since Sat Jul 30 15:07:54 2011<br />1.20G scanned out of 6.96G at 42.3M/s, 0h2m to go<br />1.20G resilvered, 17.21% done<br />config:<br /><br />   NAME          STATE     READ WRITE CKSUM<br />   rpool         ONLINE       0     0     0<br />     mirror-0    ONLINE       0     0     0<br />       c5t1d0s0  ONLINE       0     0     0<br />       c5t0d0s0  ONLINE       0     0     0  (resilvering)<br /><br /># cd /boot/grub/<br /># /sbin/installgrub stage1 stage2 /dev/rdsk/c5t0d0s0<br />stage2 written to partition 0, 277 sectors starting at 50 (abs 12594)<br />stage1 written to partition 0 sector 0 (abs 12544)<br /></pre><br />Once the resilver has finish boot reboot back to the BIOS and ensure I can actually boot of either of the disks in the rpool.<br /><br /><pre># reboot -p<br /></pre>
</div>

</div>
<div class="custom-social-buttons">   
  <div class="share-buttons-label">
    <span>Share with friends</span>
  </div>
  <div class="custom-social-button twitter">
    <a id="twitter-link" href="#"><i class="fa fa-twitter-square fa-2x"></i></a>
  </div>
  <div class="custom-social-button linkedin">
    <a id="linkedin-link" href="#"><i class="fa fa-linkedin-square fa-2x"></i></a>
  </div>
  <div class="custom-social-button googleplus">
    <a id="googleplus-link" href="#"><i class="fa fa-google-plus-square fa-2x"></i></a>
  </div>
    <div class="custom-social-button reddit">
    <a id="reddit-link" href="#"><i class="fa fa-reddit-square fa-2x"></i></a>
  </div>
  <script type="text/javascript">
	window.onload = function(){				
		var blogDomain = encodeURIComponent("http://www.resilvered.com");
		var pageTitleSpaces = encodeURIComponent("How to Shrink zfs root pool.") + "&amp;";
		var pageID = "/2011/07/how-to-shrink-zfs-root-pool";
		var pageURL = encodeURIComponent(pageID) + "&amp;";
			
		var twitterPartOne = "https://twitter.com/intent/tweet?original_referer=";
		var twitterPartTwo = "text=";
		var twitterPartThree = "tw_p=tweetbutton&amp;url=";
		var twitterPartFour = "via=bigal";
		var twitterUrl = twitterPartOne + blogDomain + pageURL + twitterPartTwo + pageTitleSpaces + twitterPartThree + blogDomain +  pageURL + twitterPartFour;
		var twitterLink = document.getElementById("twitter-link");
		twitterLink.onclick = function() {popUp=window.open(twitterUrl, 'popupwindow', 'scrollbars=yes,width=600,height=400');popUp.focus();return false };
		
		var linkedinPartOne = "http://www.linkedin.com/shareArticle?mini=true&url=";
		var linkedinPartTwo = "&title=";
		var linkedinPartThree = "&summary=";
		var linkedinPartFour = "&source=";
		var linkedinUrl = linkedinPartOne + blogDomain + pageURL + linkedinPartTwo + pageTitleSpaces + linkedinPartFour + "@bigal";
		var linkedInLink = document.getElementById("linkedin-link");
		linkedInLink.onclick = function() {popUp=window.open(linkedinUrl, 'popupwindow', 'scrollbars=yes,width=600,height=400');popUp.focus();return false };
		
		var googlePlusPartOne = "https://plus.google.com/share?url=";
		var googlePlusUrl = googlePlusPartOne + blogDomain + pageID;
		var googlePlusLink = document.getElementById("googleplus-link");
		googlePlusLink.onclick = function() {popUp=window.open(googlePlusUrl, 'popupwindow', 'scrollbars=yes,width=600,height=400');popUp.focus();return false };

        var redditPartOne = "http://reddit.com/submit?url=";
        var redditPartTwo = "&title=";
		var redditUrl = redditPartOne + blogDomain + pageURL + redditPartTwo + pageTitleSpaces;
		var redditLink = document.getElementById("reddit-link");
		redditLink.onclick = function() {popUp=window.open(redditUrl, 'popupwindow', 'scrollbars=yes,width=600,height=400');popUp.focus();return false };

	};
</script>


</div>


<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/blog/2014/08/26/Installing-Jekyll-on-CentOS-7/">
            Installing Jekyll on CentOS 7
            <small>26 Aug 2014</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/blog/2014/08/12/HHVM-on-CentOS6/">
            Installing HHVM 3.2.0 on CentOS 6.5
            <small>12 Aug 2014</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/blog/2014/07/28/Oracle-Linux-7-released/">
            Oracle Linux 7 released
            <small>28 Jul 2014</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

      
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'resilvered'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </div>

  </body>
</html>
