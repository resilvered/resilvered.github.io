---
title: "How to Shrink zfs root pool."
layout: "post"
permalink: "/2011/07/how-to-shrink-zfs-root-pool.html"
uuid: "7998470693004659297"
guid: "tag:blogger.com,1999:blog-8745734052417186264.post-7998470693004659297"
date: "2011-07-30 08:25:00"
updated: "2011-07-30 08:38:20"
description: 
blogger:
    siteid: "8745734052417186264"
    postid: "7998470693004659297"
    comments: "2"
categories: [blog, zfs, work, Solaris 11]
tags: [zfs, work, Solaris 11]
comments: true
author: 
    name: "Alan Chalmers"
    url: "https://plus.google.com/109008868852571463084?rel=author"
    image: "//lh6.googleusercontent.com/-vRVdiWd12ak/AAAAAAAAAAI/AAAAAAAAHKc/wXgK4dFefp8/s512-c/photo.jpg"
---

<div class="css-full-post-content js-full-post-content">
This exercise for me is to replace my current single disk rpool, the second disk was removed for another project, on to two slightly smaller disks. Doing so restores my root mirror but as the disks are slightly smaller some work is required.<br /><br />For reference my current root pool name is rpool, the current disk in this pool is c5t1d0, the first replacement disk is install at c5t0d0 and is empty.<br /><br />Use fdisk create a Solaris patition.<br /><pre># fdisk /dev/rdsk/c5t0d0p0<br />No fdisk table exists. The default partition for the disk is:<br /><br />a 100% "SOLARIS System" partition<br /><br />Type "y" to accept the default partition,  otherwise type "n" to edit the<br />partition table.<br />n<br /><br />        Total disk size is 7788 cylinders<br />        Cylinder size is 12544 (512 byte) blocks<br /><br />                                          Cylinders<br /> Partition   Status    Type          Start   End   Length    %<br /> =========   ======    ============  =====   ===   ======   ===<br />     1       Active    Solaris2          1  4672    4672     60<br />     2                 Win95 FAT32    4673  7787    3115     40<br /><br /><br /><br />SELECT ONE OF THE FOLLOWING:<br />1. Create a partition<br />2. Specify the active partition<br />3. Delete a partition<br />4. Change between Solaris and Solaris2 Partition IDs<br />5. Edit/View extended partitions<br />6. Exit (update disk configuration and exit)<br />7. Cancel (exit without updating disk configuration)<br />Enter Selection: 6<br /></pre><br />Use format and create Silce 0 using the whole partition<br /><br />Create temporary new pool on new disk<br /><pre># zpool create -f tpool c5t0d0s0<br /># zfs set compression=on tpool<br /></pre><br /><br />Snaphot and copy to my new tpool<br /><br /><pre># zfs snapshot -r rpool@shrink<br /># zfs send -vR rpool@shrink | zfs receive -vFd tpool<br /></pre><br /><br />Prepare for booting<br /><pre># rm /tpool/boot/grub/bootsign/pool_rpool<br /># touch /tpool/boot/grub/bootsign/pool_tpool<br /># zpool set bootfs=tpool/ROOT/Solaris_11_SRU4 tpool<br /># cd /boot/grub/<br /># /sbin/installgrub stage1 stage2 /dev/rdsk/c5t0d0s0<br />stage2 written to partition 0, 277 sectors starting at 50 (abs 12594)<br />stage1 written to partition 0 sector 0 (abs 12544)<br /># vi /tpool/boot/grub/menu.lst<br /></pre><br />Change all the references to tpool to rpool in the menu.1st file.<br /><br />At this point shutdown, on power up go into the BIOS and make sure you are booting off the right disk. If you need to be sure remove the current boot disk<br /><br />Once confrimed I'm running off my new root pool, tpool, I shutdown install the second new drive as c5t1d0 and restart<br /><br />At this stage I could just attach my new disk to the mirror and we are in buisness, but I'd like to keep my root pool name as rpool. So I perform pretty much the same proceedure as before.<br /><br />Use fdisk to partition the disk<br /><pre># fdisk /dev/rdsk/c5t0d0p0<br /></pre><br /><br />Copy over the vtoc to my new disk<br /><pre># prtvtoc  /dev/rdsk/c5t0d0s2 | fmthard -s - /dev/rdsk/c5t1d0s2<br /><br /># zpool create -f rpool c5t1d0s0<br /># zfs set compression=on rpool<br /></pre><br />Clean up my shrink snapshots from the first run<br /><pre># zfs list -t snapshot | grep shrink<br />tpool@shrink                                      23K      -    80K  -<br />tpool/ROOT@shrink                                   0      -    21K  -<br />tpool/ROOT/Solaris_11_SRU3@shrink                   0      -  3.11G  -<br />tpool/ROOT/Solaris_11_SRU4@shrink               96.2M      -  3.15G  -<br />tpool/ROOT/opensolaris@shrink                       0      -  2.04G  -<br />tpool/ROOT/opensolaris-134b@shrink                  0      -  2.75G  -<br />tpool/ROOT/opensolaris-134b-1@shrink                0      -  2.92G  -<br />tpool/dump@shrink                                   0      -  1019M  -<br />tpool/swap@shrink                                   0      -   353M  -<br /><br /># zfs destroy tpool@shrink<br /># zfs destroy tpool/ROOT@shrink<br /># zfs destroy tpool/ROOT/Solaris_11_SRU3@shrink<br /># zfs destroy tpool/ROOT/Solaris_11_SRU4@shrink<br /># zfs destroy tpool/ROOT/opensolaris-134b@shrink<br /># zfs destroy tpool/ROOT/opensolaris-134b-1@shrink<br /># zfs destroy tpool/dump@shrink<br /># zfs destroy tpool/swap@shrink<br /># zfs destroy tpool/ROOT/opensolaris@shrink<br /><br /># zfs snapshot -r tpool@shrink<br /># zfs send -vR tpool@shrink | zfs receive -vFd rpool<br /><br /># rm /rpool/boot/grub/bootsign/pool_tpool<br /># touch /rpool/boot/grub/bootsign/pool_rpool<br /># zpool set bootfs=rpool/ROOT/Solaris_11_SRU4 rpool<br /># cd /boot/grub/<br /># /sbin/installgrub stage1 stage2 /dev/rdsk/c5t1d0s0<br />stage2 written to partition 0, 277 sectors starting at 50 (abs 12594)<br />stage1 written to partition 0 sector 0 (abs 12544)<br /># vi /rpool/boot/grub/menu.lst<br /># reboot -p<br /></pre><br /><br />Change all references of tpool to rpool in menu.lst<br /><br />Reboot go back to BIOS and make sure I'm now booting of my new root pool called rpool<br /><br /><pre># zpool list<br />NAME    SIZE  ALLOC   FREE    CAP  DEDUP  HEALTH  ALTROOT<br />rpool  27.8G  6.96G  20.8G    25%  1.00x  ONLINE  -<br />tpool  27.8G  6.90G  20.8G    24%  1.00x  ONLINE  -<br /># zpool destroy tpool<br /># zpool attach -f rpool c5t1d0s0 c5t0d0s0<br />Make sure to wait until resilver is done before rebooting.<br /># zpool status rpool<br />pool: rpool<br />state: ONLINE<br />status: One or more devices is currently being resilvered.  The pool will<br />   continue to function, possibly in a degraded state.<br />action: Wait for the resilver to complete.<br />scan: resilver in progress since Sat Jul 30 15:07:54 2011<br />1.20G scanned out of 6.96G at 42.3M/s, 0h2m to go<br />1.20G resilvered, 17.21% done<br />config:<br /><br />   NAME          STATE     READ WRITE CKSUM<br />   rpool         ONLINE       0     0     0<br />     mirror-0    ONLINE       0     0     0<br />       c5t1d0s0  ONLINE       0     0     0<br />       c5t0d0s0  ONLINE       0     0     0  (resilvering)<br /><br /># cd /boot/grub/<br /># /sbin/installgrub stage1 stage2 /dev/rdsk/c5t0d0s0<br />stage2 written to partition 0, 277 sectors starting at 50 (abs 12594)<br />stage1 written to partition 0 sector 0 (abs 12544)<br /></pre><br />Once the resilver has finish boot reboot back to the BIOS and ensure I can actually boot of either of the disks in the rpool.<br /><br /><pre># reboot -p<br /></pre>
</div>
